@using GameCollectionManager.Shared.Models
@using MudBlazor
@using Newtonsoft.Json
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog DisableSidePadding="true">
    <TitleContent>
        <MudText Typo="Typo.h6" Class="px-4">Edit Game</MudText>
    </TitleContent>
    <DialogContent>
        <MudContainer Style="max-height: 600px; overflow-y: auto" Class="px-4">
            <MudButton Color="Color.Secondary" 
                      Variant="Variant.Outlined" 
                      OnClick="OpenIdentifyDialog"
                      StartIcon="@Icons.Material.Filled.Search"
                      FullWidth="true"
                      Class="mb-4">
                Re-identify Game from IGDB
            </MudButton>

            <MudTextField @bind-Value="_editedGame.name" 
                         Label="Game Name" 
                         Variant="Variant.Outlined"
                         Class="mb-4" />
            
            @if (_availablePlatforms.Any())
            {
                <MudText Typo="Typo.body2" Class="mb-2"><strong>Select Platforms:</strong></MudText>
                <MudPaper Class="pa-3 mb-4" Elevation="0" Outlined="true">
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var platform in _availablePlatforms)
                        {
                            <MudCheckBox T="bool" 
                                        Label="@platform" 
                                        Dense="true"
                                        Value="@_selectedPlatforms.Contains(platform)"
                                        ValueChanged="@((bool selected) => OnPlatformChanged(platform, selected))" />
                        }
                    </div>
                </MudPaper>
            }
            else
            {
                <MudTextField @bind-Value="_editedGame.platforms" 
                             Label="Platform(s)" 
                             Variant="Variant.Outlined"
                             Class="mb-4"
                             HelperText="Enter platforms separated by commas" />
            }
            
            <MudTextField @bind-Value="_editedGame.releasedates" 
                         Label="Release Date" 
                         Variant="Variant.Outlined"
                         Class="mb-4" />
            
            <MudTextField @bind-Value="_editedGame.genres" 
                         Label="Genres" 
                         Variant="Variant.Outlined"
                         Class="mb-4" />
            
            <MudNumericField @bind-Value="_editedGame.aggregatedrating" 
                            Label="Rating" 
                            Variant="Variant.Outlined"
                            Min="0"
                            Max="100"
                            Class="mb-4" />
            
            <MudTextField @bind-Value="_editedGame.summary" 
                         Label="Summary" 
                         Variant="Variant.Outlined"
                         Lines="5"
                         Class="mb-4" />
            
            <MudSelect @bind-Value="_editedGame.status" 
                      Label="Status" 
                      Variant="Variant.Outlined"
                      Class="mb-4">
                @foreach(var status in _gameStatuses)
                {
                    <MudSelectItem Value="@status">@status</MudSelectItem>
                }
            </MudSelect>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveChanges">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public GameDAO Game { get; set; }

    private GameDAO _editedGame;
    private List<string> _gameStatuses = new List<string>
    {
        "Not Started",
        "Playing",
        "Completed",
        "Dropped"
    };
    
    private HashSet<string> _availablePlatforms = new();
    private HashSet<string> _selectedPlatforms = new();

    protected override void OnInitialized()
    {
        if (MudDialog is null)
        {
            throw new ArgumentNullException(nameof(MudDialog), "MudDialogInstance not injected");
        }

        // Create a copy of the game to edit
        _editedGame = new GameDAO
        {
            id = Game.id,
            owner = Game.owner,
            name = Game.name,
            platforms = Game.platforms,
            releasedates = Game.releasedates,
            genres = Game.genres,
            aggregatedrating = Game.aggregatedrating,
            summary = Game.summary,
            status = Game.status,
            cover = Game.cover,
            queuepos = Game.queuepos,
            involvedcompanies = Game.involvedcompanies,
            multiplayermodes = Game.multiplayermodes,
            multiplayermodeflags = Game.multiplayermodeflags,
            howlongtobeat = Game.howlongtobeat,
            metacriticscore = Game.metacriticscore
        };

        // Initialize platforms from existing data
        InitializePlatforms();
    }

    private void InitializePlatforms()
    {
        if (!string.IsNullOrWhiteSpace(_editedGame.platforms))
        {
            var platforms = _editedGame.platforms.Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .ToList();

            foreach (var platform in platforms)
            {
                _availablePlatforms.Add(platform);
                _selectedPlatforms.Add(platform);
            }
        }
    }

    private void OnPlatformChanged(string platformName, bool selected)
    {
        if (selected)
        {
            _selectedPlatforms.Add(platformName);
        }
        else
        {
            _selectedPlatforms.Remove(platformName);
        }

        _editedGame.platforms = _selectedPlatforms.Any() 
            ? string.Join(", ", _selectedPlatforms) 
            : string.Empty;
    }

    private async Task OpenIdentifyDialog()
    {
        try
        {
            var parameters = new DialogParameters
            {
                { "GameName", _editedGame.name ?? string.Empty },
                { "CurrentGame", _editedGame }
            };

            var options = new DialogOptions 
            { 
                MaxWidth = MaxWidth.Large, 
                FullWidth = true,
                CloseOnEscapeKey = true 
            };

            var dialog = await DialogService.ShowAsync<IdentifyGameDialog>("Identify Game", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is Game selectedGame)
            {
                // Update the edited game with data from IGDB
                _editedGame.name = selectedGame.name ?? _editedGame.name;
                //if it has a rating use it
                _editedGame.aggregatedrating = selectedGame.aggregated_rating > 0 ? selectedGame.aggregated_rating : _editedGame.aggregatedrating;
                //if it has a cover use it
                _editedGame.cover = selectedGame.cover > 0 ? selectedGame.cover : _editedGame.cover;
                _editedGame.summary = selectedGame.summary ?? _editedGame.summary;

                // Update platforms from IGDB and create checkboxes
                if (selectedGame.platforms?.Any() == true)
                {
                    var newPlatforms = selectedGame.platforms
                        .Select(p => p.name)
                        .Where(n => !string.IsNullOrEmpty(n))
                        .ToList();

                    // Add new platforms to available list
                    foreach (var platform in newPlatforms)
                    {
                        _availablePlatforms.Add(platform);
                    }

                    // Keep existing selections and add new ones
                    foreach (var platform in newPlatforms)
                    {
                        _selectedPlatforms.Add(platform);
                    }

                    _editedGame.platforms = string.Join(", ", _selectedPlatforms);
                }

                // Update release dates
                if (selectedGame.release_dates?.Any() == true)
                {
                    _editedGame.releasedates = selectedGame.release_dates.FirstOrDefault()?.human ?? _editedGame.releasedates;
                }

                // Update genres
                if (selectedGame.genres?.Any() == true)
                {
                    _editedGame.genres = string.Join(", ", selectedGame.genres.Select(g => g.Name).Where(n => !string.IsNullOrEmpty(n)));
                }

                Snackbar.Add($"Updated game information from IGDB", Severity.Success);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OpenIdentifyDialog: {ex}");
            Snackbar.Add("Error identifying game", Severity.Error);
        }
    }

    private void SaveChanges()
    {
        try
        {
            // Ensure platforms string is updated from selected checkboxes
            if (_availablePlatforms.Any())
            {
                _editedGame.platforms = _selectedPlatforms.Any() 
                    ? string.Join(", ", _selectedPlatforms) 
                    : string.Empty;
            }

            Console.WriteLine($"Edited game: {JsonConvert.SerializeObject(_editedGame)}");
            MudDialog.Close(DialogResult.Ok(_editedGame));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in SaveChanges: {ex}");
            Snackbar.Add("Error saving game data", Severity.Error);
        }
    }

    private void Cancel() => MudDialog?.Close(DialogResult.Cancel());
}